"use strict";(self.webpackChunksite=self.webpackChunksite||[]).push([[5889],{6596:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>t,default:()=>p,frontMatter:()=>l,metadata:()=>a,toc:()=>o});const a=JSON.parse('{"id":"graphql/queries/spatial","title":"Spatial Queries (_spatial)","description":"Hugr provides built-in support for spatial queries through the _spatial field, available on all data objects with geometry fields. This enables powerful geographic queries like finding nearby locations, identifying intersections, and performing spatial aggregations.","source":"@site/docs/5-graphql/1-queries/9-spatial.md","sourceDirName":"5-graphql/1-queries","slug":"/graphql/queries/spatial","permalink":"/docs/graphql/queries/spatial","draft":false,"unlisted":false,"editUrl":"https://github.com/hugr-lab/hugr-lab.github.io/docs/5-graphql/1-queries/9-spatial.md","tags":[],"version":"current","lastUpdatedBy":"Claude","lastUpdatedAt":1762461702000,"sidebarPosition":9,"frontMatter":{"title":"Spatial Queries (_spatial)","sidebar_position":9},"sidebar":"docsSidebar","previous":{"title":"Dynamic Joins (_join)","permalink":"/docs/graphql/queries/dynamic-joins"},"next":{"title":"H3 Hexagonal Clustering","permalink":"/docs/graphql/queries/h3-clustering"}}');var s=i(4848),r=i(8453);const l={title:"Spatial Queries (_spatial)",sidebar_position:9},t="Spatial Queries (_spatial)",d={},o=[{value:"Basic Spatial Queries",id:"basic-spatial-queries",level:2},{value:"Finding Intersecting Features",id:"finding-intersecting-features",level:3},{value:"Within a Distance",id:"within-a-distance",level:3},{value:"Spatial Relationship Types",id:"spatial-relationship-types",level:2},{value:"INTERSECTS",id:"intersects",level:3},{value:"WITHIN",id:"within",level:3},{value:"CONTAINS",id:"contains",level:3},{value:"DISJOINT",id:"disjoint",level:3},{value:"DWITHIN",id:"dwithin",level:3},{value:"Filtering Spatial Results",id:"filtering-spatial-results",level:2},{value:"Apply Filters to Spatial Queries",id:"apply-filters-to-spatial-queries",level:3},{value:"Filter Before Spatial Join",id:"filter-before-spatial-join",level:3},{value:"Filter by Nested Relations",id:"filter-by-nested-relations",level:3},{value:"Sorting Spatial Results",id:"sorting-spatial-results",level:2},{value:"order_by for Pre-Spatial Sorting",id:"order_by-for-pre-spatial-sorting",level:3},{value:"nested_order_by for Post-Spatial Sorting",id:"nested_order_by-for-post-spatial-sorting",level:3},{value:"Sort by Distance",id:"sort-by-distance",level:3},{value:"Pagination for Spatial Results",id:"pagination-for-spatial-results",level:2},{value:"Limit Spatial Results",id:"limit-spatial-results",level:3},{value:"nested_limit and nested_offset",id:"nested_limit-and-nested_offset",level:3},{value:"Using inner with Spatial Queries",id:"using-inner-with-spatial-queries",level:2},{value:"LEFT JOIN (default)",id:"left-join-default",level:3},{value:"INNER JOIN",id:"inner-join",level:3},{value:"With Filters",id:"with-filters",level:3},{value:"Finding Coverage Gaps",id:"finding-coverage-gaps",level:3},{value:"Aggregating Spatial Results",id:"aggregating-spatial-results",level:2},{value:"Count Spatial Matches",id:"count-spatial-matches",level:3},{value:"Aggregate Attributes",id:"aggregate-attributes",level:3},{value:"Filtered Spatial Aggregation",id:"filtered-spatial-aggregation",level:3},{value:"Bucket Aggregation with Spatial",id:"bucket-aggregation-with-spatial",level:3},{value:"Complex Bucket Aggregations",id:"complex-bucket-aggregations",level:3},{value:"Using Spatial in Aggregation Queries",id:"using-spatial-in-aggregation-queries",level:2},{value:"Spatial in Single Row Aggregation",id:"spatial-in-single-row-aggregation",level:3},{value:"Spatial in Bucket Aggregation",id:"spatial-in-bucket-aggregation",level:3},{value:"Using _spatial in Grouping Keys",id:"using-_spatial-in-grouping-keys",level:3},{value:"Combining Spatial with Dynamic Joins",id:"combining-spatial-with-dynamic-joins",level:2},{value:"Multi-Level Spatial Queries",id:"multi-level-spatial-queries",level:2},{value:"Nested Spatial Relationships",id:"nested-spatial-relationships",level:3},{value:"Distance Calculations",id:"distance-calculations",level:2},{value:"Geometry Transformations",id:"geometry-transformations",level:2},{value:"Performance Considerations",id:"performance-considerations",level:2},{value:"1. Use Spatial Indexes",id:"1-use-spatial-indexes",level:3},{value:"2. Limit Results",id:"2-limit-results",level:3},{value:"3. Filter Before Spatial Operations",id:"3-filter-before-spatial-operations",level:3},{value:"4. Use Appropriate CRS/SRID",id:"4-use-appropriate-crssrid",level:3},{value:"5. Use Aggregations for Large Datasets",id:"5-use-aggregations-for-large-datasets",level:3},{value:"6. Optimize Buffer Distances",id:"6-optimize-buffer-distances",level:3},{value:"Common Patterns",id:"common-patterns",level:2},{value:"Find Nearest Features",id:"find-nearest-features",level:3},{value:"Service Area Analysis",id:"service-area-analysis",level:3},{value:"Spatial Join for Enrichment",id:"spatial-join-for-enrichment",level:3},{value:"H3 Hexagonal Clustering",id:"h3-hexagonal-clustering",level:3},{value:"Error Handling",id:"error-handling",level:2},{value:"Planning Errors (SQL Generation)",id:"planning-errors-sql-generation",level:3},{value:"SQL Execution Errors",id:"sql-execution-errors",level:3},{value:"Next Steps",id:"next-steps",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"spatial-queries-_spatial",children:"Spatial Queries (_spatial)"})}),"\n",(0,s.jsxs)(n.p,{children:["Hugr provides built-in support for spatial queries through the ",(0,s.jsx)(n.code,{children:"_spatial"})," field, available on all data objects with geometry fields. This enables powerful geographic queries like finding nearby locations, identifying intersections, and performing spatial aggregations."]}),"\n",(0,s.jsx)(n.h2,{id:"basic-spatial-queries",children:"Basic Spatial Queries"}),"\n",(0,s.jsx)(n.h3,{id:"finding-intersecting-features",children:"Finding Intersecting Features"}),"\n",(0,s.jsx)(n.p,{children:"Find all features that intersect with a geometry:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  regions {\n    id\n    name\n    boundary\n    # Find roads that intersect this region\n    _spatial(field: "boundary", type: INTERSECTS) {\n      roads(field: "geometry") {\n        id\n        name\n        road_type\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"within-a-distance",children:"Within a Distance"}),"\n",(0,s.jsx)(n.p,{children:"Find features within a specified distance:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  stores {\n    id\n    name\n    location\n    # Find customers within 5km\n    _spatial(\n      field: "location"\n      type: DWITHIN\n      buffer: 5000  # meters\n    ) {\n      customers(field: "address_location") {\n        id\n        name\n        email\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"spatial-relationship-types",children:"Spatial Relationship Types"}),"\n",(0,s.jsx)(n.h3,{id:"intersects",children:"INTERSECTS"}),"\n",(0,s.jsx)(n.p,{children:"Geometries share any portion of space:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  parcels {\n    id\n    parcel_number\n    boundary\n    # Parcels intersected by roads\n    _spatial(field: "boundary", type: INTERSECTS) {\n      roads(field: "geometry") {\n        id\n        name\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Use cases:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Finding roads crossing a region"}),"\n",(0,s.jsx)(n.li,{children:"Identifying overlapping zones"}),"\n",(0,s.jsx)(n.li,{children:"Detecting spatial conflicts"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"within",children:"WITHIN"}),"\n",(0,s.jsx)(n.p,{children:"Geometry is completely inside the reference:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  cities {\n    id\n    name\n    boundary\n    # Buildings completely within city\n    _spatial(field: "boundary", type: WITHIN) {\n      buildings(field: "footprint") {\n        id\n        address\n        building_type\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Use cases:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Finding points of interest within a boundary"}),"\n",(0,s.jsx)(n.li,{children:"Listing features inside a zone"}),"\n",(0,s.jsx)(n.li,{children:"Containment analysis"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"contains",children:"CONTAINS"}),"\n",(0,s.jsx)(n.p,{children:"Reference geometry completely contains the target:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  administrative_zones {\n    id\n    zone_name\n    boundary\n    # Zones that contain this point\n    _spatial(field: "boundary", type: CONTAINS) {\n      service_areas(field: "coverage_area") {\n        id\n        service_type\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Use cases:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Finding enclosing boundaries"}),"\n",(0,s.jsx)(n.li,{children:"Service area coverage"}),"\n",(0,s.jsx)(n.li,{children:"Jurisdiction determination"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"disjoint",children:"DISJOINT"}),"\n",(0,s.jsx)(n.p,{children:"Geometries don't share any space:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  protected_areas {\n    id\n    name\n    boundary\n    # Development zones not overlapping protected areas\n    _spatial(field: "boundary", type: DISJOINT) {\n      development_zones(field: "boundary") {\n        id\n        zone_name\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Use cases:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Finding non-overlapping regions"}),"\n",(0,s.jsx)(n.li,{children:"Exclusion zones"}),"\n",(0,s.jsx)(n.li,{children:"Conflict detection"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"dwithin",children:"DWITHIN"}),"\n",(0,s.jsx)(n.p,{children:"Within a specified distance (requires buffer parameter):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  incidents {\n    id\n    incident_type\n    location\n    # Hospitals within 10km\n    _spatial(\n      field: "location"\n      type: DWITHIN\n      buffer: 10000  # 10km in meters\n    ) {\n      hospitals(field: "location") {\n        id\n        name\n        emergency_capacity\n        distance_meters\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Use cases:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Proximity search"}),"\n",(0,s.jsx)(n.li,{children:"Catchment analysis"}),"\n",(0,s.jsx)(n.li,{children:"Service accessibility"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"filtering-spatial-results",children:"Filtering Spatial Results"}),"\n",(0,s.jsx)(n.h3,{id:"apply-filters-to-spatial-queries",children:"Apply Filters to Spatial Queries"}),"\n",(0,s.jsx)(n.p,{children:"Combine spatial and attribute filters:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  delivery_zones {\n    id\n    name\n    boundary\n    # Active orders within zone\n    _spatial(field: "boundary", type: CONTAINS) {\n      orders(\n        field: "delivery_location"\n        filter: {\n          _and: [\n            { status: { in: ["pending", "processing"] } }\n            { priority: { eq: "high" } }\n          ]\n        }\n      ) {\n        id\n        customer {\n          name\n        }\n        delivery_location\n        priority\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"filter-before-spatial-join",children:"Filter Before Spatial Join"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"filter"})," argument applies ",(0,s.jsx)(n.strong,{children:"before"})," spatial filtering:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  areas {\n    id\n    name\n    boundary\n    _spatial(field: "boundary", type: INTERSECTS) {\n      # Filter roads first, then apply spatial filter\n      roads(\n        field: "geometry"\n        filter: {\n          road_type: { eq: "highway" }\n        }\n      ) {\n        id\n        name\n        road_type\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"filter-by-nested-relations",children:"Filter by Nested Relations"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  cities {\n    id\n    name\n    boundary\n    _spatial(field: "boundary", type: CONTAINS) {\n      businesses(\n        field: "location"\n        filter: {\n          category: {\n            name: { eq: "Restaurant" }\n          }\n          rating: { gte: 4.0 }\n        }\n      ) {\n        id\n        name\n        rating\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"sorting-spatial-results",children:"Sorting Spatial Results"}),"\n",(0,s.jsx)(n.h3,{id:"order_by-for-pre-spatial-sorting",children:"order_by for Pre-Spatial Sorting"}),"\n",(0,s.jsxs)(n.p,{children:["Sort ",(0,s.jsx)(n.strong,{children:"before"})," spatial filtering:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  stores {\n    id\n    name\n    location\n    _spatial(field: "location", type: DWITHIN, buffer: 5000) {\n      customers(\n        field: "address_location"\n        order_by: [{ field: "name", direction: ASC }]\n      ) {\n        id\n        name\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"nested_order_by-for-post-spatial-sorting",children:"nested_order_by for Post-Spatial Sorting"}),"\n",(0,s.jsxs)(n.p,{children:["Sort ",(0,s.jsx)(n.strong,{children:"after"})," spatial filtering:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  stores {\n    id\n    name\n    location\n    _spatial(field: "location", type: DWITHIN, buffer: 5000) {\n      customers(\n        field: "address_location"\n        nested_order_by: [{ field: "distance", direction: ASC }]\n        nested_limit: 10\n      ) {\n        id\n        name\n        distance\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"sort-by-distance",children:"Sort by Distance"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  incident_locations {\n    id\n    location\n    _spatial(field: "location", type: DWITHIN, buffer: 20000) {\n      fire_stations(\n        field: "location"\n        nested_order_by: [{ field: "distance_meters", direction: ASC }]\n        nested_limit: 3  # Get 3 nearest stations\n      ) {\n        id\n        name\n        distance_meters\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"pagination-for-spatial-results",children:"Pagination for Spatial Results"}),"\n",(0,s.jsx)(n.h3,{id:"limit-spatial-results",children:"Limit Spatial Results"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  cities {\n    id\n    name\n    boundary\n    # Limit results\n    _spatial(field: "boundary", type: CONTAINS) {\n      points_of_interest(\n        field: "location"\n        limit: 100\n      ) {\n        id\n        name\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"nested_limit-and-nested_offset",children:"nested_limit and nested_offset"}),"\n",(0,s.jsx)(n.p,{children:"Control pagination per parent:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  cities(limit: 5) {\n    id\n    name\n    boundary\n    # Get 20 POIs per city\n    _spatial(field: "boundary", type: CONTAINS) {\n      points_of_interest(\n        field: "location"\n        nested_order_by: [{ field: "rating", direction: DESC }]\n        nested_limit: 20\n        nested_offset: 0\n      ) {\n        id\n        name\n        rating\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"using-inner-with-spatial-queries",children:"Using inner with Spatial Queries"}),"\n",(0,s.jsxs)(n.p,{children:["By default, spatial queries use LEFT JOIN, returning all parent records even if no spatially related records are found. Use ",(0,s.jsx)(n.code,{children:"inner: true"})," to include only records that have spatial matches."]}),"\n",(0,s.jsx)(n.h3,{id:"left-join-default",children:"LEFT JOIN (default)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  stores {\n    id\n    name\n    location\n    # All stores, even those without nearby customers\n    _spatial(field: "location", type: DWITHIN, buffer: 5000) {\n      customers(field: "address_location") {\n        id\n        name\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Result:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"All stores are returned"}),"\n",(0,s.jsx)(n.li,{children:"Stores without nearby customers have empty spatial results"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"inner-join",children:"INNER JOIN"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  stores {\n    id\n    name\n    location\n    # Only stores with nearby customers\n    _spatial(field: "location", type: DWITHIN, buffer: 5000) {\n      customers(\n        field: "address_location"\n        inner: true\n      ) {\n        id\n        name\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Result:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Only stores that have customers within 5km are returned"}),"\n",(0,s.jsx)(n.li,{children:"Stores without nearby customers are excluded from results"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"with-filters",children:"With Filters"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  delivery_zones {\n    id\n    name\n    boundary\n    # Only zones with active orders inside\n    _spatial(field: "boundary", type: CONTAINS) {\n      orders(\n        field: "delivery_location"\n        filter: { status: { in: ["pending", "processing"] } }\n        inner: true\n      ) {\n        id\n        status\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Returns only delivery zones that contain active orders."}),"\n",(0,s.jsx)(n.h3,{id:"finding-coverage-gaps",children:"Finding Coverage Gaps"}),"\n",(0,s.jsxs)(n.p,{children:["Use ",(0,s.jsx)(n.code,{children:"inner: false"})," (default) to find records without spatial matches:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  # Find areas without service coverage\n  residential_areas {\n    id\n    name\n    boundary\n    _spatial(field: "boundary", type: INTERSECTS) {\n      service_zones(field: "coverage_area") {\n        id\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Filter client-side for areas where ",(0,s.jsx)(n.code,{children:"service_zones"})," is empty."]}),"\n",(0,s.jsx)(n.h2,{id:"aggregating-spatial-results",children:"Aggregating Spatial Results"}),"\n",(0,s.jsx)(n.h3,{id:"count-spatial-matches",children:"Count Spatial Matches"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  cities {\n    id\n    name\n    boundary\n    # Count buildings in city\n    _spatial(field: "boundary", type: CONTAINS) {\n      buildings_aggregation(field: "footprint") {\n        _rows_count\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"aggregate-attributes",children:"Aggregate Attributes"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  regions {\n    id\n    name\n    area\n    boundary\n    # Aggregate population of contained cities\n    _spatial(field: "boundary", type: CONTAINS) {\n      cities_aggregation(field: "boundary") {\n        _rows_count\n        population {\n          sum\n          avg\n        }\n        area {\n          sum\n        }\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"filtered-spatial-aggregation",children:"Filtered Spatial Aggregation"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  service_areas {\n    id\n    name\n    coverage_area\n    _spatial(field: "coverage_area", type: CONTAINS) {\n      # Aggregate only residential buildings\n      buildings_aggregation(\n        field: "footprint"\n        filter: {\n          building_type: { eq: "residential" }\n        }\n      ) {\n        _rows_count\n        floor_area {\n          sum\n        }\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"bucket-aggregation-with-spatial",children:"Bucket Aggregation with Spatial"}),"\n",(0,s.jsx)(n.p,{children:"Group spatially related data:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  districts {\n    id\n    name\n    boundary\n    _spatial(field: "boundary", type: CONTAINS) {\n      # Group businesses by type\n      businesses_bucket_aggregation(field: "location") {\n        key {\n          business_type\n        }\n        aggregations {\n          _rows_count\n          revenue {\n            sum\n            avg\n          }\n        }\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"complex-bucket-aggregations",children:"Complex Bucket Aggregations"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  delivery_zones {\n    id\n    zone_name\n    boundary\n    _spatial(field: "boundary", type: CONTAINS) {\n      orders_bucket_aggregation(\n        field: "delivery_location"\n        order_by: [\n          { field: "aggregations.total.sum", direction: DESC }\n        ]\n      ) {\n        key {\n          status\n          created_at(bucket: day)\n        }\n        aggregations {\n          _rows_count\n          total {\n            sum\n            avg\n          }\n        }\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"using-spatial-in-aggregation-queries",children:"Using Spatial in Aggregation Queries"}),"\n",(0,s.jsx)(n.h3,{id:"spatial-in-single-row-aggregation",children:"Spatial in Single Row Aggregation"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  cities_aggregation {\n    _rows_count\n    population { sum }\n    # Aggregate spatially related POIs\n    _spatial(field: "boundary", type: CONTAINS) {\n      points_of_interest_aggregation(field: "location") {\n        _rows_count\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"spatial-in-bucket-aggregation",children:"Spatial in Bucket Aggregation"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  cities_bucket_aggregation {\n    key {\n      country\n      state\n    }\n    aggregations {\n      _rows_count\n      population { sum avg }\n      # Spatial aggregation per group\n      _spatial(field: "boundary", type: CONTAINS) {\n        businesses_aggregation(field: "location") {\n          _rows_count\n        }\n        businesses_bucket_aggregation(field: "location") {\n          key {\n            business_type\n          }\n          aggregations {\n            _rows_count\n          }\n        }\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"using-_spatial-in-grouping-keys",children:"Using _spatial in Grouping Keys"}),"\n",(0,s.jsxs)(n.p,{children:["You can use ",(0,s.jsx)(n.code,{children:"_spatial"})," in bucket aggregation keys to group by fields from spatially related data:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  stores_bucket_aggregation {\n    key {\n      # Group by region from spatially related cities\n      _spatial(field: "location", type: WITHIN) {\n        cities(field: "boundary") {\n          region\n          name\n        }\n      }\n    }\n    aggregations {\n      _rows_count\n      revenue { sum avg }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"This groups stores by the city region they are located in, using spatial containment."}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Practical example"})," - Orders by delivery zone:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  orders_bucket_aggregation {\n    key {\n      status\n      # Group by delivery zone using spatial relationship\n      delivery_zone: _spatial(field: "delivery_location", type: WITHIN) {\n        zones(field: "boundary") {\n          zone_id\n          zone_name\n          priority_level\n        }\n      }\n    }\n    aggregations {\n      _rows_count\n      total { sum avg }\n      delivery_time { avg }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:'This creates grouping by order status and delivery zone, enabling analysis like "average delivery time by zone and status".'}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Multi-dimensional spatial grouping"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  events_bucket_aggregation {\n    key {\n      event_type\n      # Spatial grouping by neighborhood\n      neighborhood: _spatial(field: "location", type: WITHIN) {\n        neighborhoods(field: "boundary") {\n          name\n          district\n        }\n      }\n      # Spatial grouping by service area\n      service_area: _spatial(field: "location", type: WITHIN) {\n        service_areas(field: "coverage") {\n          area_code\n          service_level\n        }\n      }\n    }\n    aggregations {\n      _rows_count\n      participants { sum avg }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"This enables complex spatial analysis grouping events by type, neighborhood district, and service area."}),"\n",(0,s.jsx)(n.h2,{id:"combining-spatial-with-dynamic-joins",children:"Combining Spatial with Dynamic Joins"}),"\n",(0,s.jsxs)(n.p,{children:["Use both ",(0,s.jsx)(n.code,{children:"_spatial"})," and ",(0,s.jsx)(n.code,{children:"_join"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  stores {\n    id\n    name\n    location\n    # Spatial: nearby customers\n    _spatial(field: "location", type: DWITHIN, buffer: 5000) {\n      customers(field: "address_location") {\n        id\n        name\n        # Dynamic join: get their orders\n        _join(fields: ["id"]) {\n          orders(fields: ["customer_id"]) {\n            id\n            total\n          }\n        }\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"multi-level-spatial-queries",children:"Multi-Level Spatial Queries"}),"\n",(0,s.jsx)(n.h3,{id:"nested-spatial-relationships",children:"Nested Spatial Relationships"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  countries {\n    id\n    name\n    boundary\n    # Cities in country\n    _spatial(field: "boundary", type: CONTAINS) {\n      cities(field: "boundary") {\n        id\n        name\n        # Buildings in each city\n        _spatial(field: "boundary", type: CONTAINS) {\n          buildings(field: "footprint") {\n            id\n            address\n          }\n        }\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"distance-calculations",children:"Distance Calculations"}),"\n",(0,s.jsx)(n.p,{children:"Some databases provide distance in results:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  my_location {\n    location\n    _spatial(field: "location", type: DWITHIN, buffer: 10000) {\n      stores(\n        field: "location"\n        nested_order_by: [{ field: "_distance", direction: ASC }]\n      ) {\n        id\n        name\n        _distance  # Distance in meters (if supported)\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"geometry-transformations",children:"Geometry Transformations"}),"\n",(0,s.jsx)(n.p,{children:"Query with geometry transformations:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  points {\n    id\n    location\n    # Buffer the point and find intersecting polygons\n    location(transform: Buffer, buffer_distance: 1000)\n    _spatial(\n      field: "location"\n      type: INTERSECTS\n    ) {\n      zones(field: "boundary") {\n        id\n        zone_name\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"performance-considerations",children:"Performance Considerations"}),"\n",(0,s.jsx)(n.h3,{id:"1-use-spatial-indexes",children:"1. Use Spatial Indexes"}),"\n",(0,s.jsx)(n.p,{children:"Ensure spatial indexes exist on geometry columns:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- PostgreSQL/PostGIS example\nCREATE INDEX idx_stores_location ON stores USING GIST(location);\nCREATE INDEX idx_customers_location ON customers USING GIST(address_location);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"2-limit-results",children:"2. Limit Results"}),"\n",(0,s.jsx)(n.p,{children:"Always limit spatial query results:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'# Good\nquery {\n  cities {\n    id\n    _spatial(field: "boundary", type: CONTAINS) {\n      buildings(\n        field: "footprint"\n        limit: 1000\n      ) {\n        id\n      }\n    }\n  }\n}\n\n# Avoid - May return millions of features\nquery {\n  cities {\n    id\n    _spatial(field: "boundary", type: CONTAINS) {\n      buildings(field: "footprint") {\n        id\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"3-filter-before-spatial-operations",children:"3. Filter Before Spatial Operations"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'# Better - Filter first\nquery {\n  cities(filter: { population: { gte: 100000 } }) {\n    id\n    _spatial(field: "boundary", type: CONTAINS) {\n      buildings(field: "footprint") {\n        id\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"4-use-appropriate-crssrid",children:"4. Use Appropriate CRS/SRID"}),"\n",(0,s.jsx)(n.p,{children:"Ensure consistent spatial reference systems:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'# Define in schema\ntype locations @table(name: "locations") {\n  id: Int! @pk\n  name: String!\n  geom: Geometry @geometry_info(type: POINT, srid: 4326)\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"5-use-aggregations-for-large-datasets",children:"5. Use Aggregations for Large Datasets"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'# Better - Aggregate instead of fetching all\nquery {\n  cities {\n    id\n    _spatial(field: "boundary", type: CONTAINS) {\n      buildings_aggregation(field: "footprint") {\n        _rows_count\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"6-optimize-buffer-distances",children:"6. Optimize Buffer Distances"}),"\n",(0,s.jsx)(n.p,{children:"Use appropriate buffer sizes:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'# Good - Reasonable buffer\n_spatial(field: "location", type: DWITHIN, buffer: 5000)  # 5km\n\n# Avoid - Excessive buffer\n_spatial(field: "location", type: DWITHIN, buffer: 1000000)  # 1000km\n'})}),"\n",(0,s.jsx)(n.h2,{id:"common-patterns",children:"Common Patterns"}),"\n",(0,s.jsx)(n.h3,{id:"find-nearest-features",children:"Find Nearest Features"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query FindNearest($lat: Float!, $lon: Float!) {\n  # Create a point query\n  points: spatial_query(\n    geometry: { type: "Point", coordinates: [$lon, $lat] }\n  ) {\n    _spatial(field: "geometry", type: DWITHIN, buffer: 50000) {\n      stores(\n        field: "location"\n        nested_order_by: [{ field: "_distance", direction: ASC }]\n        nested_limit: 5\n      ) {\n        id\n        name\n        _distance\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"service-area-analysis",children:"Service Area Analysis"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query ServiceCoverage {\n  service_providers {\n    id\n    name\n    service_area\n    _spatial(field: "service_area", type: CONTAINS) {\n      # Count covered population\n      census_blocks_aggregation(field: "boundary") {\n        _rows_count\n        population { sum }\n      }\n      # Breakdown by demographics\n      census_blocks_bucket_aggregation(field: "boundary") {\n        key {\n          demographic_category\n        }\n        aggregations {\n          population { sum }\n        }\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"spatial-join-for-enrichment",children:"Spatial Join for Enrichment"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query EnrichAddresses {\n  addresses {\n    id\n    street_address\n    location\n    # Find containing zone\n    _spatial(field: "location", type: WITHIN) {\n      administrative_zones(field: "boundary", limit: 1) {\n        zone_code\n        zone_name\n        jurisdiction\n      }\n    }\n    # Find nearby amenities\n    _spatial(field: "location", type: DWITHIN, buffer: 500) {\n      amenities(\n        field: "location"\n        filter: {\n          amenity_type: { in: ["school", "hospital", "park"] }\n        }\n      ) {\n        amenity_type\n        name\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"h3-hexagonal-clustering",children:"H3 Hexagonal Clustering"}),"\n",(0,s.jsxs)(n.p,{children:["For spatial clustering and aggregation, Hugr supports the ",(0,s.jsx)(n.strong,{children:"H3 hexagonal grid system"}),". H3 divides geographic areas into hexagonal cells at different resolutions, enabling powerful spatial analysis and visualization."]}),"\n",(0,s.jsxs)(n.p,{children:["See ",(0,s.jsx)(n.a,{href:"/docs/graphql/queries/h3-clustering",children:"H3 Hexagonal Clustering"})," for detailed documentation on:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"H3 resolution levels and use cases"}),"\n",(0,s.jsxs)(n.li,{children:["Spatial aggregation with ",(0,s.jsx)(n.code,{children:"h3()"})," query"]}),"\n",(0,s.jsxs)(n.li,{children:["Value distribution with ",(0,s.jsx)(n.code,{children:"distribution_by"})," and ",(0,s.jsx)(n.code,{children:"distribution_by_bucket"})]}),"\n",(0,s.jsx)(n.li,{children:"Multi-source data integration"}),"\n",(0,s.jsx)(n.li,{children:"Performance optimization"}),"\n",(0,s.jsx)(n.li,{children:"Real-world examples (heatmaps, coverage analysis, ML features)"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,s.jsx)(n.p,{children:"Spatial query errors are categorized into two types:"}),"\n",(0,s.jsx)(n.h3,{id:"planning-errors-sql-generation",children:"Planning Errors (SQL Generation)"}),"\n",(0,s.jsx)(n.p,{children:"Validation errors caught during query planning, with specific error paths:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Invalid field names:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  parcels {\n    id\n    _spatial(field: "non_existent_field", type: INTERSECTS) {\n      roads(field: "geometry") {\n        id\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Response:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "data": null,\n  "errors": [\n    {\n      "message": "Field \'non_existent_field\' does not exist in type \'parcels\'",\n      "path": ["parcels", "_spatial"]\n    }\n  ]\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Invalid field types:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  parcels {\n    id\n    _spatial(field: "name", type: INTERSECTS) {  # \'name\' is String, not Geometry\n      roads(field: "geometry") {\n        id\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Response:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "data": null,\n  "errors": [\n    {\n      "message": "Field \'name\' is not a Geometry type",\n      "path": ["parcels", "_spatial"]\n    }\n  ]\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"sql-execution-errors",children:"SQL Execution Errors"}),"\n",(0,s.jsx)(n.p,{children:"Runtime errors during SQL execution, reported at query level:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Invalid geometry:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  parcels {\n    id\n    invalid_boundary  # Self-intersecting polygon\n    _spatial(field: "invalid_boundary", type: INTERSECTS) {\n      roads(field: "geometry") {\n        id\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Response:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "data": null,\n  "errors": [\n    {\n      "message": "Invalid geometry: self-intersection"\n    }\n  ]\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"SRID mismatch:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'query {\n  parcels {\n    _spatial(field: "location_4326", type: INTERSECTS) {\n      zones(field: "boundary_3857") {  # Different SRID!\n        id\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Response:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "data": null,\n  "errors": [\n    {\n      "message": "SRID mismatch: 4326 vs 3857"\n    }\n  ]\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Solutions:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Planning errors"})," - Fix field names and ensure fields are Geometry type"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Execution errors"})," - Validate geometries and ensure matching SRIDs using ",(0,s.jsx)(n.code,{children:"transforms"})," argument"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Review ",(0,s.jsx)(n.a,{href:"/docs/graphql/queries/aggregations",children:"Aggregations"})," for detailed aggregation patterns"]}),"\n",(0,s.jsxs)(n.li,{children:["See ",(0,s.jsx)(n.a,{href:"/docs/graphql/queries/dynamic-joins",children:"Dynamic Joins"})," for combining spatial with dynamic joins"]}),"\n",(0,s.jsxs)(n.li,{children:["Check ",(0,s.jsx)(n.a,{href:"/docs/engine-configuration/schema-definition/data-objects/overview",children:"Schema Definition - Data Objects"})," for geometry field configuration"]}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>t});var a=i(6540);const s={},r=a.createContext(s);function l(e){const n=a.useContext(r);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);