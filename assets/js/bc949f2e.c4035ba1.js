"use strict";(self.webpackChunksite=self.webpackChunksite||[]).push([[7991],{6430:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"engine-configuration/schema-definition/function","title":"Functions","description":"Defining and using functions in Hugr schema","source":"@site/docs/4-engine-configuration/3-schema-definition/2-function.md","sourceDirName":"4-engine-configuration/3-schema-definition","slug":"/engine-configuration/schema-definition/function","permalink":"/docs/engine-configuration/schema-definition/function","draft":false,"unlisted":false,"editUrl":"https://github.com/hugr-lab/hugr-lab.github.io/docs/4-engine-configuration/3-schema-definition/2-function.md","tags":[],"version":"current","lastUpdatedBy":"vgsml","lastUpdatedAt":1756711778000,"sidebarPosition":3,"frontMatter":{"title":"Functions","sidebar_position":3,"description":"Defining and using functions in Hugr schema"},"sidebar":"docsSidebar","previous":{"title":"Data Types","permalink":"/docs/engine-configuration/schema-definition/data-types"},"next":{"title":"Data objects","permalink":"/docs/category/data-objects"}}');var s=t(4848),a=t(8453);const r={title:"Functions",sidebar_position:3,description:"Defining and using functions in Hugr schema"},o=void 0,c={},l=[{value:"Defining Functions",id:"defining-functions",level:2},{value:"Mutation function definition",id:"mutation-function-definition",level:2},{value:"Function Calls",id:"function-calls",level:2}];function d(n){const e={code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.p,{children:"The many data sources can provide functions to return specific data or perform operations on the data. These functions can be used in queries and mutations to manipulate and retrieve data in a more flexible way."}),"\n",(0,s.jsx)(e.p,{children:"For database sources it can be stored functions or SQL queries, that will execute in the context of the database."}),"\n",(0,s.jsxs)(e.p,{children:["For http data sources, it can be REST API calls that executes the special SQL function ",(0,s.jsx)(e.code,{children:"http_data_source_request_scalar"})," in the inmemory DuckDB database context."]}),"\n",(0,s.jsx)(e.h2,{id:"defining-functions",children:"Defining Functions"}),"\n",(0,s.jsxs)(e.p,{children:["To define a function in the schema definition, you should extend the system type ",(0,s.jsx)(e.code,{children:"Function"})," or ",(0,s.jsx)(e.code,{children:"MutationFunction"}),", if you want to create a mutation function that will execute in a transaction. Add function definition as a type field and mark it with the ",(0,s.jsx)(e.code,{children:"@function"})," directive."]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-graphql",children:'extend type Function {\n  scalar_function(arg1: String!): String\n    @function(name: "scalar_function")\n  type_function(arg1: String!, arg2: Int!): function_result\n    @function(name: "type_function")\n  table_function(arg1: String!): [function_result]\n    @function(name: "table_function")\n}\n\ntype function_result {\n  value: String\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:"Functions can accept positional scalar arguments, and return scalars, structured types, or lists of them.\nFor PostgreSQL functions the returned structured type automaticaly casts from record to structured type and for functions that returns list of structured types, the database function should return a record set."}),"\n",(0,s.jsxs)(e.p,{children:["If the function returns the JSON (or JSONB in PostgreSQL), the ",(0,s.jsx)(e.code,{children:"@function"})," directive must include the ",(0,s.jsx)(e.code,{children:"json_cast"})," flag set to true to cast result from JSON to struct and ",(0,s.jsx)(e.code,{children:"is_table"})," flag if it is a table function."]}),"\n",(0,s.jsxs)(e.p,{children:["The ",(0,s.jsx)(e.code,{children:"@function"})," directive defines how the function should be executed."]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-graphql",children:'# define function info (apply to the extended Function or MutationFunction type)\ndirective @function(\n  """\n  Name of the database function, if there is no existing function use the abstract name.\n  """\n  name: String!,\n  """\n  SQL query to use it as a function\n  """\n  sql: String,\n  """\n  Flag that indicates whether to skip null arguments if there is only one argument.\n  """\n  skip_null_arg: Boolean,\n  """\n  Flag that indicates whether to treat the function as a table function.\n  """\n  is_table: Boolean,\n  """\n  Flag that indicates whether to cast the result from JSON to struct.\n  """\n  json_cast: Boolean\n) on FIELD_DEFINITION\n'})}),"\n",(0,s.jsx)(e.p,{children:"You can also define functions as result of any valid SQL expression, that return a scalar, structured type, or a list of them."}),"\n",(0,s.jsxs)(e.p,{children:["The function arguments can be used in the SQL expression, you should refer to them by their names in brackets ",(0,s.jsx)(e.code,{children:"[]"}),"."]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-graphql",children:"extend type Function {\n  \"Current weather from OpenWeatherMap in raw format\"\n  current_weather(lat: Float!, lon: Float!): current_weather_response\n    @function(\n      name: \"get_current_weather_raw\"\n      sql: \"http_data_source_request_scalar([$catalog], '/data/2.5/weather', 'GET', '{}'::JSON, {lat: [lat], lon: [lon], units: 'metric'}::JSON, '{}'::JSON, '')\"\n      json_cast: true\n    )\n}\n"})}),"\n",(0,s.jsxs)(e.p,{children:["You can rename the fields of returned structure types and sets using ",(0,s.jsx)(e.code,{children:"@field_source"})," directive."]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-graphql",children:'type current_weather_response {\n  id: Int\n  name: String\n  base: String\n  coord: coords\n  dt: BigInt\n  main: main_weather_info\n  weather: [weather_conditions]\n  clouds: clouds_info\n  rain: perc_info\n  snow: perc_info\n  visibility: Int\n  wind: wind_info\n  common: sys_info @field_source(field: "sys")\n}\n\n\ntype coords {\n  lat: Float\n  lon: Float\n}\n\ntype clouds_info {\n  all: Float\n}\n\ntype perc_info {\n  current: Float @field_source(field: "1h")\n}\n\ntype wind_info {\n  speed: Float\n  deg: Float\n  gust: Float\n}\n\ntype main_weather_info {\n  feels_like: Float\n  grnd_level: Float\n  humidity: Float\n  pressure: Float\n  sea_level: Float\n  temp: Float\n  temp_max: Float\n  temp_min: Float\n}\n\ntype weather_conditions {\n  id: Int\n  name: String @field_source(field: "main")\n  icon: String\n  description: String\n}\n\ntype sys_info {\n  sunrise: BigInt\n  sunset: BigInt\n  country: String\n}\n'})}),"\n",(0,s.jsxs)(e.p,{children:["To make a call to the http API, you can use the ",(0,s.jsx)(e.code,{children:"http_data_source_request_scalar"})," function in the SQL query. This function allows you to specify the HTTP method, headers, and body for the request, as well as any query parameters."]}),"\n",(0,s.jsxs)(e.p,{children:["The ",(0,s.jsx)(e.code,{children:"http_data_source_request_scalar"})," SQL function arguments:"]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"catalog"}),": The name of http data source."]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"path"}),": The path of the HTTP API endpoint."]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"method"}),": The HTTP method to use (e.g., GET, POST)."]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"headers"}),": The headers to include in the request."]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"query_params"}),": The query parameters for the request."]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"body"}),": The body of the request."]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"jq"}),": jq expression to transform the response."]}),"\n"]}),"\n",(0,s.jsxs)(e.p,{children:["You can use the special variable ",(0,s.jsx)(e.code,{children:"[$catalog]"})," to refer to the data source context."]}),"\n",(0,s.jsx)(e.h2,{id:"mutation-function-definition",children:"Mutation function definition"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-graphql",children:"extend type MutationFunction {\n  \"Disable sensor\"\n  disable_sensor(id: ID!): operation_status\n    @function(\n      name: \"disable_sensor\"\n      sql: \"http_data_source_request_scalar([$catalog], '/api/sensors/disable', 'POST', '{}'::JSON, {id: [id]}::JSON, '{}'::JSON, '')\"\n    )\n}\n"})}),"\n",(0,s.jsx)(e.h2,{id:"function-calls",children:"Function Calls"}),"\n",(0,s.jsxs)(e.p,{children:["The functions can be called directly in the GraphQL queries or it can be used as fields in the data objects if it was defined in the schema definition. It is possible to add function calls fields to the data objects from different sources and map their arguments through ",(0,s.jsx)(e.code,{children:"extension"})," data source."]}),"\n",(0,s.jsxs)(e.p,{children:["Direct calls:\nAll direct function calls set in the ",(0,s.jsx)(e.code,{children:"function"})," field in ",(0,s.jsx)(e.code,{children:"query_root"})," can be used in the queries."]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-graphql",children:"query {\n  function {\n    current_weather(lat: 40.7128, lon: -74.0060) {\n      id\n      name\n      main {\n        temp\n        pressure\n        humidity\n      }\n    }\n  }\n}\n"})}),"\n",(0,s.jsx)(e.p,{children:"Or for mutations:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-graphql",children:'mutation {\n  function {\n    disable_sensor(id: "sensor-1") {\n      success\n    }\n  }\n}\n'})}),"\n",(0,s.jsxs)(e.p,{children:["If ",(0,s.jsx)(e.code,{children:"module"})," is set for the function it can be put in the ",(0,s.jsx)(e.code,{children:"module"})," field ",(0,s.jsx)(e.code,{children:"function"})," type."]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-graphql",children:"extend type Function {\n  \"Current weather from OpenWeatherMap in raw format\"\n  current_weather(lat: Float!, lon: Float!): current_weather_response\n    @function(\n      name: \"get_current_weather_raw\"\n      sql: \"http_data_source_request_scalar([$catalog], '/data/2.5/weather', 'GET', '{}'::JSON, {lat: [lat], lon: [lon], units: 'metric'}::JSON, '{}'::JSON, '')\"\n      json_cast: true\n    )\n    @module(name: \"service.weather\")\n}\n"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-graphql",children:"query {\n  function {\n    services {\n      weather {\n        current_weather(lat: 40.7128, lon: -74.0060) {\n          id\n          name\n          main {\n            temp\n            pressure\n            humidity\n          }\n        }\n      }\n    }\n  }\n}\n"})}),"\n",(0,s.jsx)(e.p,{children:"Function calls as fields:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-graphql",children:"query {\n  cities {\n    id\n    name\n    country\n    geom(transforms: [Centroid])\n    current_weather: current_weather {\n      main {\n        temp\n        pressure\n        humidity\n      }\n    }\n  }\n}\n"})})]})}function u(n={}){const{wrapper:e}={...(0,a.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(d,{...n})}):d(n)}},8453:(n,e,t)=>{t.d(e,{R:()=>r,x:()=>o});var i=t(6540);const s={},a=i.createContext(s);function r(n){const e=i.useContext(a);return i.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:r(n.components),i.createElement(a.Provider,{value:e},n.children)}}}]);