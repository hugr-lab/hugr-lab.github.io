"use strict";(self.webpackChunksite=self.webpackChunksite||[]).push([[8255],{5532:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>d,contentTitle:()=>a,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"engine-configuration/schema-definition/data-objects/joins","title":"Joins and Spatial Joins","description":"For extending types with joins across different data sources, see Extensions & Cross-Source Subqueries.","source":"@site/docs/4-engine-configuration/3-schema-definition/3-data-objects/8-joins.md","sourceDirName":"4-engine-configuration/3-schema-definition/3-data-objects","slug":"/engine-configuration/schema-definition/data-objects/joins","permalink":"/docs/engine-configuration/schema-definition/data-objects/joins","draft":false,"unlisted":false,"editUrl":"https://github.com/hugr-lab/hugr-lab.github.io/docs/4-engine-configuration/3-schema-definition/3-data-objects/8-joins.md","tags":[],"version":"current","lastUpdatedBy":"Claude","lastUpdatedAt":1762714317000,"sidebarPosition":8,"frontMatter":{"title":"Joins and Spatial Joins","sidebar_position":8},"sidebar":"docsSidebar","previous":{"title":"Relations and Foreign Keys","permalink":"/docs/engine-configuration/schema-definition/data-objects/relations"},"next":{"title":"Function Calls","permalink":"/docs/engine-configuration/schema-definition/data-objects/function-calls"}}');var o=i(4848),t=i(8453);const r={title:"Joins and Spatial Joins",sidebar_position:8},a="Joins and Spatial Joins",d={},l=[{value:"Custom Joins with @join",id:"custom-joins-with-join",level:2},{value:"Complex Join Conditions",id:"complex-join-conditions",level:3},{value:"Query-Time Joins",id:"query-time-joins",level:2},{value:"Cross-Source Query-Time Joins",id:"cross-source-query-time-joins",level:3},{value:"Aggregating Query-Time Joins",id:"aggregating-query-time-joins",level:3},{value:"Spatial Joins",id:"spatial-joins",level:2},{value:"Spatial Join Types",id:"spatial-join-types",level:3},{value:"Complex Spatial Queries",id:"complex-spatial-queries",level:3},{value:"Spatial Joins with Buffer",id:"spatial-joins-with-buffer",level:3},{value:"Using @unnest with Joins",id:"using-unnest-with-joins",level:2},{value:"Performance Optimization",id:"performance-optimization",level:2},{value:"Pushdown Control",id:"pushdown-control",level:3},{value:"Join Indexes",id:"join-indexes",level:3},{value:"Limiting Join Results",id:"limiting-join-results",level:3},{value:"Cross-Source Joins in Extensions",id:"cross-source-joins-in-extensions",level:2},{value:"Combining Join Types",id:"combining-join-types",level:2}];function c(n){const e={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...n.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(e.header,{children:(0,o.jsx)(e.h1,{id:"joins-and-spatial-joins",children:"Joins and Spatial Joins"})}),"\n",(0,o.jsx)(e.admonition,{title:"Cross-Source Joins",type:"tip",children:(0,o.jsxs)(e.p,{children:["For extending types with joins across different data sources, see ",(0,o.jsx)(e.a,{href:"/docs/engine-configuration/extension#extending-types-with-cross-source-joins",children:"Extensions & Cross-Source Subqueries"}),"."]})}),"\n",(0,o.jsx)(e.p,{children:"Beyond foreign key relationships, Hugr provides flexible join capabilities including custom joins, query-time joins, and spatial joins for geographic data."}),"\n",(0,o.jsx)(e.h2,{id:"custom-joins-with-join",children:"Custom Joins with @join"}),"\n",(0,o.jsx)(e.p,{children:"Define custom join conditions beyond simple foreign keys:"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-graphql",children:'type customers @table(name: "customers") {\n  id: Int! @pk\n  name: String!\n  location: Geometry @geometry_info(type: POINT, srid: 4326)\n  \n  # Join with service areas based on location\n  service_areas: [service_areas] @join(\n    references_name: "service_areas"\n    sql: "ST_Within([source.location], [dest.boundary])"\n  )\n}\n'})}),"\n",(0,o.jsx)(e.h3,{id:"complex-join-conditions",children:"Complex Join Conditions"}),"\n",(0,o.jsx)(e.p,{children:"Combine multiple conditions:"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-graphql",children:'extend type orders {\n  similar_orders: [orders] @join(\n    references_name: "orders"\n    source_fields: ["customer_id"]\n    references_fields: ["customer_id"]\n    sql: """\n      [source.id] != [dest.id] AND\n      ABS([source.total] - [dest.total]) < 50 AND\n      [dest.created_at] BETWEEN \n        [source.created_at] - INTERVAL \'7 days\' \n        AND [source.created_at] + INTERVAL \'7 days\'\n    """\n  )\n}\n'})}),"\n",(0,o.jsx)(e.h2,{id:"query-time-joins",children:"Query-Time Joins"}),"\n",(0,o.jsxs)(e.p,{children:["Every data object includes a ",(0,o.jsx)(e.code,{children:"_join"})," field for dynamic joins:"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-graphql",children:'query {\n  customers {\n    id\n    name\n    \n    # Join with orders at query time\n    _join(fields: ["id"]) {\n      orders(fields: ["customer_id"]) {\n        id\n        total\n      }\n    }\n  }\n}\n'})}),"\n",(0,o.jsx)(e.h3,{id:"cross-source-query-time-joins",children:"Cross-Source Query-Time Joins"}),"\n",(0,o.jsx)(e.p,{children:"Join data from different sources:"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-graphql",children:'query {\n  postgres_customers {\n    id\n    name\n    \n    _join(fields: ["email"]) {\n      mysql_users(fields: ["email"]) {\n        last_login\n        preferences\n      }\n    }\n  }\n}\n'})}),"\n",(0,o.jsx)(e.h3,{id:"aggregating-query-time-joins",children:"Aggregating Query-Time Joins"}),"\n",(0,o.jsx)(e.p,{children:"Aggregate joined data:"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-graphql",children:'query {\n  products {\n    id\n    name\n    \n    _join(fields: ["id"]) {\n      reviews_aggregation(fields: ["product_id"]) {\n        _rows_count\n        rating {\n          avg\n        }\n      }\n    }\n  }\n}\n'})}),"\n",(0,o.jsx)(e.p,{children:"Aggregate data with joined results:"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-graphql",children:'query {\n  products_aggregation {\n    _join(fields: ["id"]) {\n      reviews(fields: ["product_id"]) {\n        _rows_count\n        rating {\n          avg\n        }\n      }\n    }\n  }\n}\n'})}),"\n",(0,o.jsx)(e.h2,{id:"spatial-joins",children:"Spatial Joins"}),"\n",(0,o.jsxs)(e.p,{children:["For data objects with geometry fields, use ",(0,o.jsx)(e.code,{children:"_spatial"})," for geographic joins:"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-graphql",children:'query {\n  stores {\n    id\n    name\n    location\n    \n    # Find customers within 5km\n    _spatial(\n      field: "location"\n      type: DWITHIN\n      buffer: 5000\n    ) {\n      customers(field: "address_location") {\n        id\n        name\n      }\n    }\n  }\n}\n'})}),"\n",(0,o.jsx)(e.h3,{id:"spatial-join-types",children:"Spatial Join Types"}),"\n",(0,o.jsx)(e.p,{children:"Available spatial operations:"}),"\n",(0,o.jsxs)(e.table,{children:[(0,o.jsx)(e.thead,{children:(0,o.jsxs)(e.tr,{children:[(0,o.jsx)(e.th,{children:"Type"}),(0,o.jsx)(e.th,{children:"Description"})]})}),(0,o.jsxs)(e.tbody,{children:[(0,o.jsxs)(e.tr,{children:[(0,o.jsx)(e.td,{children:(0,o.jsx)(e.code,{children:"INTERSECTS"})}),(0,o.jsx)(e.td,{children:"Geometries share any portion of space"})]}),(0,o.jsxs)(e.tr,{children:[(0,o.jsx)(e.td,{children:(0,o.jsx)(e.code,{children:"WITHIN"})}),(0,o.jsx)(e.td,{children:"Geometry is completely inside reference"})]}),(0,o.jsxs)(e.tr,{children:[(0,o.jsx)(e.td,{children:(0,o.jsx)(e.code,{children:"CONTAINS"})}),(0,o.jsx)(e.td,{children:"Reference is completely inside geometry"})]}),(0,o.jsxs)(e.tr,{children:[(0,o.jsx)(e.td,{children:(0,o.jsx)(e.code,{children:"DISJOINT"})}),(0,o.jsx)(e.td,{children:"Geometries don't share any space"})]}),(0,o.jsxs)(e.tr,{children:[(0,o.jsx)(e.td,{children:(0,o.jsx)(e.code,{children:"DWITHIN"})}),(0,o.jsx)(e.td,{children:"Within specified distance (uses buffer)"})]})]})]}),"\n",(0,o.jsx)(e.h3,{id:"complex-spatial-queries",children:"Complex Spatial Queries"}),"\n",(0,o.jsx)(e.p,{children:"Combine spatial joins with filters:"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-graphql",children:'query {\n  delivery_zones {\n    id\n    name\n    boundary\n    \n    # Active orders within zone\n    _spatial(field: "boundary", type: CONTAINS) {\n      orders(\n        field: "delivery_location"\n        filter: { status: { in: ["pending", "processing"] } }\n      ) {\n        id\n        customer {\n          name\n        }\n        delivery_location\n      }\n      \n      # Aggregate orders by status\n      orders_bucket_aggregation(field: "delivery_location") {\n        key {\n          status\n        }\n        aggregations {\n          _rows_count\n          total {\n            sum\n          }\n        }\n      }\n    }\n  }\n}\n'})}),"\n",(0,o.jsx)(e.h3,{id:"spatial-joins-with-buffer",children:"Spatial Joins with Buffer"}),"\n",(0,o.jsx)(e.p,{children:"Find related objects within a distance:"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-graphql",children:'query {\n  incidents {\n    id\n    type\n    location\n    \n    # Hospitals within 10km\n    _spatial(\n      field: "location"\n      type: DWITHIN\n      buffer: 10000  # meters\n    ) {\n      hospitals(field: "location") {\n        id\n        name\n        emergency_capacity\n      }\n    }\n  }\n}\n'})}),"\n",(0,o.jsx)(e.h2,{id:"using-unnest-with-joins",children:"Using @unnest with Joins"}),"\n",(0,o.jsx)(e.p,{children:"Flatten joined results for aggregation:"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-graphql",children:"query {\n  orders_bucket_aggregation {\n    key {\n      customer {\n        country\n      }\n      # Flatten product details\n      order_details @unnest {\n        product {\n          category {\n            name\n          }\n        }\n      }\n    }\n    aggregations {\n      _rows_count\n      order_details {\n        quantity {\n          sum\n        }\n      }\n    }\n  }\n}\n"})}),"\n",(0,o.jsxs)(e.p,{children:[(0,o.jsx)(e.strong,{children:"Warning"}),": ",(0,o.jsx)(e.code,{children:"@unnest"})," multiplies rows like SQL JOIN - use carefully!"]}),"\n",(0,o.jsx)(e.h2,{id:"performance-optimization",children:"Performance Optimization"}),"\n",(0,o.jsx)(e.h3,{id:"pushdown-control",children:"Pushdown Control"}),"\n",(0,o.jsx)(e.p,{children:"Prevent join pushdown to database when needed:"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-graphql",children:"query {\n  customers {\n    id\n    orders @no_pushdown {\n      id\n      total\n    }\n  }\n}\n"})}),"\n",(0,o.jsx)(e.h3,{id:"join-indexes",children:"Join Indexes"}),"\n",(0,o.jsx)(e.p,{children:"Ensure indexes on:"}),"\n",(0,o.jsxs)(e.ul,{children:["\n",(0,o.jsx)(e.li,{children:"Join condition fields"}),"\n",(0,o.jsx)(e.li,{children:"Spatial columns (using spatial indexes)"}),"\n",(0,o.jsx)(e.li,{children:"Fields used in complex SQL conditions"}),"\n"]}),"\n",(0,o.jsx)(e.h3,{id:"limiting-join-results",children:"Limiting Join Results"}),"\n",(0,o.jsx)(e.p,{children:"Always limit joined data for performance:"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-graphql",children:'query {\n  regions {\n    id\n    name\n    \n    _spatial(field: "boundary", type: CONTAINS) {\n      locations(\n        field: "point"\n        limit: 100  # Limit spatial join results\n        order_by: [{ field: "population", direction: DESC }]\n      ) {\n        id\n        name\n        population\n      }\n    }\n  }\n}\n'})}),"\n",(0,o.jsx)(e.h2,{id:"cross-source-joins-in-extensions",children:"Cross-Source Joins in Extensions"}),"\n",(0,o.jsx)(e.p,{children:"Define joins between different data sources:"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-graphql",children:'# In extension data source\nextend type postgres_orders {\n  # Join with MySQL customer data\n  mysql_customer: mysql_customers @join(\n    references_name: "mysql_customers"\n    source_fields: ["customer_email"]\n    references_fields: ["email"]\n  )\n  \n  # Join with DuckDB analytics\n  analytics: duckdb_order_analytics @join(\n    references_name: "duckdb_order_analytics"\n    source_fields: ["id"]\n    references_fields: ["order_id"]\n  )\n}\n'})}),"\n",(0,o.jsx)(e.h2,{id:"combining-join-types",children:"Combining Join Types"}),"\n",(0,o.jsx)(e.p,{children:"Use multiple join types together:"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-graphql",children:'query {\n  stores {\n    id\n    name\n    location\n    \n    # Regular join\n    inventory {\n      product_id\n      quantity\n    }\n    \n    # Aggregation on joined data\n    inventory_aggregation {\n      _rows_count\n      quantity {\n        sum\n      }\n    }\n    \n    # Spatial join\n    _spatial(field: "location", type: DWITHIN, buffer: 1000) {\n      competitors(field: "location") {\n        name\n      }\n    }\n    \n    # Query-time join\n    _join(fields: ["id"]) {\n      reviews(fields: ["store_id"]) {\n        rating\n        comment\n      }\n      # Aggregation on query-time join\n      reviews_aggregation(fields: ["store_id"]) {\n        _rows_count\n        rating {\n          avg\n        }\n      }\n    }\n  }\n}\n'})}),"\n",(0,o.jsx)(e.p,{children:"Use joined data in aggregations:"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-graphql",children:'query {\n  stores_bucket_aggregation {\n    key {\n      customer {\n        country\n      }\n      # Flatten product details\n      order_details @unnest {\n        product {\n          category {\n            name\n          }\n        }\n      }\n    }\n    aggregations {\n      _rows_count\n      _spatial(field: "location", type: DWITHIN, buffer: 1000) {\n        competitors(field: "location") {\n          name{\n            list(distinct: true)\n          }\n        }\n      }\n    }\n  }\n}\n'})})]})}function u(n={}){const{wrapper:e}={...(0,t.R)(),...n.components};return e?(0,o.jsx)(e,{...n,children:(0,o.jsx)(c,{...n})}):c(n)}},8453:(n,e,i)=>{i.d(e,{R:()=>r,x:()=>a});var s=i(6540);const o={},t=s.createContext(o);function r(n){const e=s.useContext(t);return s.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(o):n.components||o:r(n.components),s.createElement(t.Provider,{value:e},n.children)}}}]);